<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Master Hub</title>
    <link rel="icon" href="icons/icon.svg">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --border: #333; --accent: #0a84ff; }
        body { background: var(--bg); color: #eee; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        header { background: var(--panel); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 18px; }
        .tabs { display: flex; gap: 5px; }
        .tab-btn { background: transparent; border: none; color: #888; padding: 8px 16px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        .tab-btn.active { background: var(--border); color: #fff; }
        .tab-btn:hover { color: #fff; }

        /* Main Content */
        main { flex: 1; position: relative; overflow: hidden; }
        .view { display: none; height: 100%; width: 100%; overflow: auto; padding: 20px; box-sizing: border-box; }
        .view.active { display: block; }

        /* Grid View */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding-bottom: 80px; }
        .cam-card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .cam-header { padding: 10px; background: #252525; display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; }
        .cam-preview { aspect-ratio: 16/9; background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .status-overlay { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .cam-controls { padding: 10px; display: flex; gap: 10px; justify-content: flex-end; }

        /* Recordings View */
        .file-list { display: flex; flex-direction: column; gap: 8px; max-width: 800px; margin: 0 auto; }
        .file-item { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Floating Dock (Optional Remote) */
        #quick-dock { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(30,30,30,0.9); backdrop-filter: blur(10px);
            border: 1px solid #444; border-radius: 12px; padding: 10px;
            display: flex; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.3s;
        }
        #quick-dock.hidden { transform: translate(-50%, 150%); }
    </style>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <h1>Studio Master</h1>
            <span style="font-size:10px; background:#333; padding:2px 6px; border-radius:4px; color:#aaa;">ALPHA</span>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('cameras')">Cameras</button>
            <button class="tab-btn" onclick="switchTab('recordings')">Recordings</button>
            <button class="tab-btn" onclick="window.open('remote.html','_blank')">Pop-out Remote â†—</button>
        </div>
        <div>
            <button class="btn btn-sm" onclick="scanDevices()">Rescan USB</button>
        </div>
    </header>

    <main>
        <!-- Camera Grid -->
        <div id="view-cameras" class="view active">
            <div id="grid" class="grid">
                <!-- Cards injected here -->
            </div>
        </div>

        <!-- Recordings -->
        <div id="view-recordings" class="view">
            <div style="display:flex; justify-content:space-between; max-width:800px; margin:0 auto 20px;">
                <h2>Saved Clips</h2>
                <button class="btn btn-sm" onclick="loadFiles()">Refresh List</button>
            </div>
            <div id="file-list" class="file-list">
                <p style="color:#666; text-align:center;">Loading...</p>
            </div>
        </div>
    </main>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <script src="js/utils.js"></script>
    <script src="js/camera-core.js"></script>

    <script>
        // --- Tab Logic ---
        function switchTab(name) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${name}`).classList.add('active');
            event.target.classList.add('active');
            if (name === 'recordings') loadFiles();
        }

        // --- Core Logic ---
        const grid = document.getElementById('grid');
        const sessionMap = new Map(); 
        const mainSocket = io({ transports: ['websocket', 'polling'] });

        // 1. Network Cameras
        mainSocket.on('connect', () => mainSocket.emit('join-remote'));
        mainSocket.on('camera-list', (cams) => {
            Array.from(grid.querySelectorAll('.network-cam')).forEach(el => el.remove());
            cams.forEach(c => createNetworkCard(c.id, c.meta.name));
        });
        mainSocket.on('camera-joined', c => createNetworkCard(c.id, c.meta.name));
        mainSocket.on('camera-left', c => {
            const el = document.getElementById(`net-card-${c.id}`);
            if (el) el.remove();
        });

        function createNetworkCard(id, name) {
            if (document.getElementById(`net-card-${id}`)) return;
            
            // Check if this is actually one of our own local USB cameras
            let isLocal = false;
            for (const session of sessionMap.values()) {
                if (session.socket && session.socket.id === id) {
                    isLocal = true;
                    break;
                }
            }
            if (isLocal) return; // Don't show myself as a remote camera

            const card = document.createElement('div');
            card.id = `net-card-${id}`;
            card.className = 'cam-card network-cam';
            card.style.borderColor = '#0a84ff';
            card.innerHTML = `
                <div class="cam-header">
                    <span style="color:#0a84ff;">${name || 'Remote Cam'}</span>
                    <span>WIRELESS</span>
                </div>
                <div class="cam-preview">
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#222; color:#666;">
                        <span style="font-size:12px;">Active on Remote</span>
                    </div>
                </div>
                <div class="cam-controls">
                    <button class="btn btn-sm" onclick="window.open('remote.html?cam=${id}', '_blank')">CONTROL</button>
                </div>
            `;
            grid.insertBefore(card, grid.firstChild);
        }

        // 2. Local USB Cameras
        async function scanDevices() {
            sessionMap.clear();
            const devs = await navigator.mediaDevices.enumerateDevices();
            const videoInputs = devs.filter(d => d.kind === 'videoinput');
            
            // Cleanup existing USB cards
            Array.from(grid.querySelectorAll('.usb-cam')).forEach(el => el.remove());

            if (videoInputs.length === 0) {
                grid.innerHTML += '<p style="padding:20px; color:#666;">No USB cameras found.</p>';
                return;
            }

            videoInputs.forEach((device, index) => {
                createUSBCard(device, index);
            });
        }

        function createUSBCard(device, index) {
            const id = device.deviceId;
            const name = device.label || `USB Camera ${index + 1}`;
            
            const card = document.createElement('div');
            card.className = 'cam-card usb-cam';
            card.innerHTML = `
                <div class="cam-header">
                    <span>${name}</span>
                    <span id="sid-${index}" style="font-family:monospace; color:#666;">OFF</span>
                </div>
                <div class="cam-preview">
                    <video id="vid-${index}" autoplay muted playsinline></video>
                </div>
                <div class="cam-controls">
                    <button id="btn-${index}" class="btn btn-sm" onclick="toggleCamera(${index}, '${id}', '${name.replace(/'/g, "")}')">START HOSTING</button>
                    <button id="remote-btn-${index}" class="btn btn-sm hidden">REMOTE</button>
                </div>
            `;
            grid.appendChild(card);
        }

        async function toggleCamera(index, deviceId, name) {
            const btn = document.getElementById(`btn-${index}`);
            const remoteBtn = document.getElementById(`remote-btn-${index}`);
            const videoEl = document.getElementById(`vid-${index}`);
            const sidEl = document.getElementById(`sid-${index}`);

            if (sessionMap.has(index)) {
                // Stop logic could be added here, but reload is safer for now
                location.reload(); 
                return;
            }

            btn.innerText = "Init...";
            btn.disabled = true;

            try {
                const socket = io({ forceNew: true, transports: ['websocket', 'polling'] });
                socket.on('connect', () => {
                    sidEl.innerText = "LIVE";
                    sidEl.style.color = "#00cc00";
                    remoteBtn.classList.remove('hidden');
                    // Fix the onclick handler to use the NEW socket ID
                    remoteBtn.onclick = () => window.open(`remote.html?cam=${socket.id}`, '_blank');
                });

                const session = new CameraSession(socket, videoEl, null, null, name);
                sessionMap.set(index, session);
                
                const maxRes = await session.probeMaxResolution(deviceId);
                await session.start({ deviceId: deviceId, resolution: maxRes });
                
                btn.innerText = "STOP";
                btn.disabled = false;
                btn.style.background = "#cc0000";
                btn.style.borderColor = "#cc0000";

            } catch (e) {
                console.error(e);
                btn.innerText = "Error";
            }
        }

        // 3. Recordings Logic
        function loadFiles() {
            fetch('/list-recordings')
                .then(r => r.json())
                .then(files => {
                    const list = document.getElementById('file-list');
                    if (files.length === 0) {
                        list.innerHTML = '<p>No recordings yet.</p>';
                        return;
                    }
                    list.innerHTML = files.map(f => `
                        <div class="file-item">
                            <div>
                                <div style="font-weight:bold; color:#0a84ff;">${f.name}</div>
                                <div style="font-size:11px; color:#666;">${new Date(f.time).toLocaleString()}</div>
                            </div>
                            <a href="/recordings/${f.name}" class="btn btn-sm" download>Download</a>
                        </div>
                    `).join('');
                });
        }

        // Init
        // Request permission once to see labels
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => { s.getTracks().forEach(t => t.stop()); scanDevices(); })
            .catch(e => console.warn("Cam permission needed"));

    </script>
</body>
</html>
