<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Dock</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: #1a1a1a; color: #eee; font-family: sans-serif; padding: 10px; overflow-y: auto; }
        .panel { display: flex; flex-direction: column; gap: 8px; }
        select, button { width: 100%; padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; cursor: pointer; }
        button:hover { background: #444; }
        button.active { background: #0a84ff; border-color: #0a84ff; }
        button.rec { background: #cc0000; border-color: #aa0000; }
        button.rec.recording { background: #ff0000; animation: pulse 1.5s infinite; }
        .row { display: flex; gap: 5px; }
        .label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 2px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="panel">
        <div>
            <div class="label">Target Camera</div>
            <select id="cam-select"><option>Scanning...</option></select>
        </div>

        <div class="row">
            <button id="rec-btn" class="rec">RECORD</button>
            <button id="photo-btn">SNAP</button>
        </div>

        <div>
            <div class="label">Features</div>
            <div class="row">
                <button id="tether-btn" style="font-size:10px;">USB SAVE</button>
                <button id="audio-btn" style="font-size:10px;">High-Fidelity Audio</button>
            </div>
        </div>

        <div>
            <div class="label">Zoom / Focus</div>
            <div class="row">
                <button onclick="changeZoom(-0.5)">-</button>
                <button onclick="changeZoom(0.5)">+</button>
                <button id="af-btn">AF</button>
            </div>
        </div>
        
        <div>
            <div class="label">Lens</div>
            <select id="lens-select"><option>Lens...</option></select>
        </div>

        <div>
            <div class="label">Switch / Preview</div>
            <div id="multiview" style="display:flex; gap:5px; overflow-x:auto; padding-bottom:5px; background:#000; border-radius:4px; padding:5px;">
                <!-- Thumbs injected here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io({ transports: ['websocket', 'polling'] });
        let activeCamId = null;
        let isRecording = false;
        let zoomLevel = 1.0;

        const els = {
            camSelect: document.getElementById('cam-select'),
            recBtn: document.getElementById('rec-btn'),
            tetherBtn: document.getElementById('tether-btn'),
            audioBtn: document.getElementById('audio-btn'),
            lensSelect: document.getElementById('lens-select'),
            multiview: document.getElementById('multiview')
        };

        socket.on('connect', () => socket.emit('join-remote'));

        socket.on('camera-list', (cams) => {
            const unique = [...new Set(cams.map(c => c.id))]; 
            els.camSelect.innerHTML = unique.map(id => {
                const c = cams.find(x => x.id === id);
                return `<option value="${id}">${c.meta.name || id.substr(0,4)}</option>`;
            }).join('');
            
            // Build thumbs
            els.multiview.innerHTML = '';
            unique.forEach(id => {
                const c = cams.find(x => x.id === id);
                createThumb(id, c.meta.name || id.substr(0,4));
            });

            if (unique.length > 0 && !activeCamId) {
                activeCamId = unique[0];
                selectThumb(activeCamId);
                refresh();
            }
        });

        // Preview Frames
        socket.on('preview-frame', (d) => {
            const img = document.getElementById(`thumb-img-${d.from}`);
            if (img) img.src = d.payload;
        });

        function createThumb(id, name) {
            const div = document.createElement('div');
            div.id = `thumb-${id}`;
            div.style = "min-width:60px; height:45px; position:relative; cursor:pointer; background:#222; border:1px solid #444; border-radius:3px; overflow:hidden;";
            div.onclick = () => switchCamera(id);
            div.innerHTML = `
                <img id="thumb-img-${id}" style="width:100%; height:100%; object-fit:cover;">
                <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.7); font-size:8px; text-align:center;">${name}</div>
            `;
            els.multiview.appendChild(div);
        }

        function selectThumb(id) {
            Array.from(els.multiview.children).forEach(el => {
                el.style.borderColor = (el.id === `thumb-${id}`) ? '#0a84ff' : '#444';
                el.style.opacity = (el.id === `thumb-${id}`) ? '1' : '0.6';
            });
        }

        function switchCamera(id) {
            activeCamId = id;
            els.camSelect.value = id;
            selectThumb(id);
            refresh();
            socket.emit('program-change', id); // Switch OBS view if listening
        }

        socket.on('camera-state', d => {
            if (d.from !== activeCamId) return;
            isRecording = (d.payload.state === 'recording' || d.payload === 'recording');
            els.recBtn.classList.toggle('recording', isRecording);
            els.recBtn.innerText = isRecording ? "STOP" : "RECORD";
        });

        socket.on('camera-devices', d => {
            if (d.from !== activeCamId) return;
            els.lensSelect.innerHTML = d.payload.map(x => `<option value="${x.deviceId}">${x.label || 'Lens'}</option>`).join('');
        });

        // Controls
        els.camSelect.onchange = () => { activeCamId = els.camSelect.value; refresh(); };
        function refresh() { if(activeCamId) socket.emit('request-state', { target: activeCamId }); }
        function send(cmd, payload={}) { if(activeCamId) socket.emit(cmd, { target: activeCamId, payload }); }

        els.recBtn.onclick = () => send(isRecording ? 'stop-recording' : 'start-recording');
        document.getElementById('photo-btn').onclick = () => send('take-photo');
        document.getElementById('af-btn').onclick = () => send('control-camera', { focusMode: 'continuous' });
        
        els.tetherBtn.onclick = () => { 
            els.tetherBtn.classList.toggle('active'); 
            send('set-tether', els.tetherBtn.classList.contains('active')); 
        };
        
        els.audioBtn.onclick = () => {
            els.audioBtn.classList.toggle('active');
            send('set-audio-mode', els.audioBtn.classList.contains('active') ? 'pro' : 'voice');
        };

        els.lensSelect.onchange = () => send('switch-lens', els.lensSelect.value);

        function changeZoom(delta) {
            zoomLevel = Math.max(1, Math.min(10, zoomLevel + delta));
            send('control-camera', { zoom: zoomLevel });
        }
    </script>
</body>
</html>
