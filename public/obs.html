<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Multi-View</title>
    <style>
        body, html { margin: 0; padding: 0; background: #000; width: 100%; height: 100%; overflow: hidden; }
        .splash { position: fixed; z-index: 100; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; color: white; font-family: sans-serif; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(50%, 1fr)); 
            width: 100%; height: 100%; 
            transition: all 0.3s;
        }
        .cam-container { position: relative; width: 100%; height: 100%; border: 1px solid #333; transition: all 0.3s; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .label { 
            position: absolute; bottom: 10px; left: 10px; 
            background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; 
            font-family: sans-serif; font-size: 14px; border-radius: 4px;
        }
        .grid.program-mode .cam-container { display: none; border: none; }
        .grid.program-mode .cam-container.active { display: block; }
        .btn-start { background: #0a84ff; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="splash" class="splash">
        <h1>OBS Studio View</h1>
        <button class="btn-start" onclick="startView()">START MULTI-VIEW</button>
        <p style="color: #666; font-size: 12px; margin-top: 10px;">Enables Audio/Video Autoplay</p>
    </div>

    <div id="grid" class="grid"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io({ transports: ['websocket', 'polling'], reconnection: true, autoConnect: false });
        const grid = document.getElementById('grid');
        const peers = {}; 
        let currentProgram = 'grid'; 

        function startView() {
            document.getElementById('splash').style.display = 'none';
            socket.connect();
        }

        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('join-remote');
        });

        socket.on('program-change', (targetId) => {
            currentProgram = targetId;
            updateLayout();
        });

        function updateLayout() {
            if (currentProgram === 'grid') {
                grid.classList.remove('program-mode');
                Array.from(grid.children).forEach(el => el.classList.remove('active'));
            } else {
                grid.classList.add('program-mode');
                Array.from(grid.children).forEach(el => {
                    if (el.id === `cam-${currentProgram}`) el.classList.add('active');
                    else el.classList.remove('active');
                });
            }
        }

        function createVideoSlot(id, name) {
            if (document.getElementById(`cam-${id}`)) return;
            const div = document.createElement('div');
            div.className = 'cam-container';
            div.id = `cam-${id}`;
            div.innerHTML = `<video id="vid-${id}" autoplay playsinline muted></video><div class="label">${name || id.substr(0,4)}</div>`;
            grid.appendChild(div);
            updateLayout();
        }

        function removeVideoSlot(id) {
            const el = document.getElementById(`cam-${id}`);
            if (el) el.remove();
            if (peers[id]) { peers[id].close(); delete peers[id]; }
            updateLayout();
        }

        socket.on('camera-list', (cameras) => {
            cameras.forEach(c => createVideoSlot(c.id, c.meta.name));
            socket.emit('request-state', { target: 'all' }); 
        });

        socket.on('camera-joined', (c) => {
            createVideoSlot(c.id, c.meta.name);
            socket.emit('request-state', { target: c.id });
        });

        socket.on('camera-left', (c) => removeVideoSlot(c.id));

        socket.on('offer', async (data) => {
            const id = data.from;
            if (peers[id]) peers[id].close();
            
            const p = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peers[id] = p;

            p.ontrack = e => { 
                const v = document.getElementById(`vid-${id}`);
                if (v && v.srcObject !== e.streams[0]) {
                    v.srcObject = e.streams[0];
                    v.muted = false; // OBS requires audio to verify stream usually, but keep muted if feedback
                    // Avoid race conditions with play()
                    if (v.paused) {
                        v.play().catch(e => {
                            if (e.name !== "AbortError") console.error("Play error:", e);
                        });
                    }
                }
            };

            p.onicecandidate = e => { 
                if (e.candidate) socket.emit('remote-candidate', { target: id, payload: e.candidate }); 
            };

            await p.setRemoteDescription(new RTCSessionDescription(data.payload));
            const ans = await p.createAnswer();
            await p.setLocalDescription(ans);
            socket.emit('answer', { target: id, payload: ans });
        });

        socket.on('camera-candidate', (data) => {
            if (peers[data.from]) peers[data.from].addIceCandidate(new RTCIceCandidate(data.payload)).catch(e => {});
        });
    </script>
</body>
</html>
